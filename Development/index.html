<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alco Ticketing System</title>
   <style>
   
   .tickets-container {
        display: block;              /* Enable Flexbox */
        justify-content: space-around; /* Distribute space evenly around the items */
        width: 100%;                /* Take full width of the container */
    }
	
	
    .ticket-item {
        border: 4px solid lightblue; /* Set the border color */
        border-radius: 10px;        /* Rounded corners */
        padding: 20px;              /* Some padding inside the border */
        margin: 10px;               /* Margin outside the border */
        background-color: #ffffff;  /* Light blue background */
        width: 50%;               /* Fixed width */
        height: auto;               /* Automatic height */
    }
	
	
	#ticketsinside {
        border: 4px solid lightblue; /* Set the border color */
        border-radius: 10px;        /* Rounded corners */
        padding: 20px;              /* Some padding inside the border */
        margin: 10px;               /* Margin outside the border */
        background-color: #ffffff;  /* Light blue background */
        width: 80%;               /* Fixed width */
        height: 100%               /* Automatic height adjustment */
    }

    #tickets {
        border: 4px solid lightblue; /* Set the border color */
        border-radius: 10px;        /* Rounded corners */
        padding: 20px;              /* Some padding inside the border */
        margin: 10px;               /* Margin outside the border */
        background-color: #ffffff;  /* Light blue background */
        width: 600px;               /* Fixed width */
        height: 100%               /* Automatic height adjustment */
    }

    /* Existing styles */
    body {
        font-family: Arial, sans-serif;
    }
    input[type="text"], textarea {
        width: 200px;
        height: 30px;
        padding: 10px;
        margin-top: 5px;
        margin-bottom: 10px;
        border: 2px solid #64adc4;
        border-radius: 5px;
        background-color: #eaf6f9;
        box-sizing: border-box;
    }
    button, select {
        background-color: #64adc4;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        margin-top: 10px;
        cursor: pointer;
    }
    select {
        text-align: center;
        width: 200px;
        height: 40px;
        padding-left: 0px;
        border: 1px solid #4CAF50;
    }
</style>

</head>
<body>
<center>
    <!-- Ticket Submission Form -->
    <div id = "tickets">
        <h2>Submit a Ticket</h2>
        <input type="text" id="ticketTitle" placeholder="Ticket Issue"><br>
        <input type="text" id="ticketName" placeholder="Requester"><br>
        <textarea id="ticketDesc" placeholder="Description"></textarea><br>
        <select id="ticketPriority">
            <option value="Low">Low Priority</option>
            <option value="Medium">Medium Priority</option>
            <option value="High">High Priority</option>
        </select><br>
        <button onclick="submitTicket()">Submit Ticket</button>
    </div>

    <!-- Display Tickets -->
	
	 <div class="tickets-container">
	 
	<div id = "tickets">
	
	<div id="openTicketsList">
    <h2>Open Tickets</h2>
</div>

</div>
<br>

<div id = "tickets">
<!-- Pending Tickets -->

<h2>Pending Tickets</h2>

<select id="sortFilter" onchange="loadTickets()">
        <option value="all">Sort By Person</option>
        <option value="Adnen">Adnen</option>
        <option value="David">David</option>
        <option value="Octavio">Octavio</option>
    </select><br>
	<br>
	
<div id="pendingTicketsList">
    
</div>



<div id="memberManagement">
    <h2>Manage Members</h2>
    <div id="memberList">
        <select id="memberSelect">
            <option value="Adnen">Adnen</option>
            <option value="David">David</option>
            <option value="Octavio">Octavio</option>
        </select>
    </div>
    <button onclick="addMember()">Add Member</button>
</div>



	
</div>



    
	</div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, addDoc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDgqB5FaU1Zreq3H5WwfDo7WSUEkVOdKxU",
            authDomain: "formfiller-b9856.firebaseapp.com",
            projectId: "formfiller-b9856",
            storageBucket: "formfiller-b9856.appspot.com",
            messagingSenderId: "424653050423",
            appId: "1:424653050423:web:dfae46bc004eaedefae5b2",
            measurementId: "G-9WPM6EEMQ7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

       window.submitTicket = async () => {
    const title = document.getElementById('ticketTitle').value;
    const name = document.getElementById('ticketName').value;
    const description = document.getElementById('ticketDesc').value;
    const priority = document.getElementById('ticketPriority').value;

    if (title && name && description) {
        const docRef = await addDoc(collection(db, "tickets"), {
            title: title,
            requestor: name,
            description: description,
            priority: priority,
            status: "New", // Default status
            created: new Date()
        });

        console.log("Ticket submitted with ID:", docRef.id);
        loadTickets();  // Reload tickets after submission
    }
};








window.loadMembers = async () => {
    const membersRef = collection(db, "members");
    const memberSnapshot = await getDocs(membersRef);
    const members = memberSnapshot.docs.map(doc => doc.data().name);
    updateMemberDropdowns(members);
};

function updateMemberDropdowns(members) {
    const memberSelect = document.getElementById('memberSelect');
    const sortFilter = document.getElementById('sortFilter');
    const assignSelects = document.querySelectorAll('[id^="assign-"]');

    memberSelect.innerHTML = '';
    sortFilter.innerHTML = '<option value="all">Sort By Person</option>';

    members.forEach(member => {
        const option = document.createElement('option');
        option.value = member;
        option.text = member;

        memberSelect.appendChild(option.cloneNode(true));
        sortFilter.appendChild(option.cloneNode(true));

        assignSelects.forEach(select => {
            select.appendChild(option.cloneNode(true));
        });
    });
}

window.addMember = async () => {
    let newMemberName = prompt("Enter the name of the new member:");
    if (newMemberName) {
        // Add the new member to Firestore
        await addDoc(collection(db, "members"), { name: newMemberName });
        loadMembers(); // Reload members from Firestore
    }
};



function getAssignmentControl(docId, status) {
    let members = Array.from(document.getElementById('memberSelect').options).map(option => option.value);
    let optionsHTML = members.map(member => `<option value='${member}'>${member}</option>`).join('');

    if (status === "New") {
        return `<select id='assign-${docId}'>
                    <option value=''>Assign Ticket</option>
                    ${optionsHTML}
                </select>
                <br><button onclick='deleteTicket("${docId}")'>Delete</button> <button onclick='assignTicket("${docId}")'>Save</button>`;
    } else {
        return `<button onclick='unassignTicket("${docId}")'>Unassign</button>
                <button onclick='deleteTicket("${docId}")'>Delete</button>`;
    }
}










function updateSortFilter(members) {
    const sortFilter = document.getElementById('sortFilter');
    sortFilter.innerHTML = '<option value="all">Sort By Person</option>';
    members.forEach(member => {
        const option = document.createElement('option');
        option.value = member;
        option.text = member;
        sortFilter.appendChild(option);
    });
}







window.loadTickets = async () => {
    console.log("Loading tickets...");
    const openTicketsList = document.getElementById('openTicketsList');
    const pendingTicketsList = document.getElementById('pendingTicketsList');
    const filter = document.getElementById('sortFilter').value;

    // Clear the existing content
    openTicketsList.innerHTML = '<h2>Open Tickets</h2>';
    pendingTicketsList.innerHTML = '<h2></h2>';

    const querySnapshot = await getDocs(collection(db, "tickets"));
    console.log(`Number of tickets fetched: ${querySnapshot.size}`);

    let tickets = [];
    querySnapshot.forEach((doc) => {
        let ticket = { id: doc.id, ...doc.data() };
        tickets.push(ticket);
    });

    // Priority mapping
    const priorityMap = { 'High': 3, 'Medium': 2, 'Low': 1 };

    // Sort tickets by priority
    tickets.sort((a, b) => priorityMap[b.priority] - priorityMap[a.priority]);

    tickets.forEach((ticket) => {
        console.log(`Processing ticket: ${ticket.id}`, ticket);

        // Format the creation date
        const createdAt = ticket.created.toDate(); // Convert timestamp to Date object
        const formattedDate = createdAt.toLocaleDateString("en-US", { year: 'numeric', month: 'long', day: 'numeric' });

        let ticketHTML = `<div class='ticket-item' style='display: block;'>
            <h2>${ticket.title}</h2>
            <b>From:</b> ${ticket.requestor}
            <p>${ticket.priority} Priority - Created: ${formattedDate}</p>
            <p>${ticket.status}</p>
            <div id='ticketsinside'>
                ${ticket.description}
            </div>
            <br>
            ${getAssignmentControl(ticket.id, ticket.status)}
        </div>`;

        // Check if the ticket is New, it should always be visible in open tickets
        if (ticket.status === "New") {
            openTicketsList.innerHTML += ticketHTML;
        } else {
            // For non-new tickets, apply the filter
            let isVisible = (filter === 'all' || ticket.status.includes(`Assigned to ${filter}`));
            if (isVisible) {
                pendingTicketsList.innerHTML += ticketHTML;
            }
        }
    });
	//const querySnapshot = await getDocs(collection(db, "tickets"));
	let members = Array.from(document.getElementById('memberSelect').options).map(option => option.value);
    updateSortFilter(members);
};




        window.assignTicket = async (docId) => {
            const selectedPerson = document.getElementById(`assign-${docId}`).value;
            const ticketRef = doc(db, "tickets", docId);
            if (selectedPerson !== '') {
                await updateDoc(ticketRef, {
                    status: `Assigned to ${selectedPerson}`
                });
                console.log("Ticket assigned!");
                loadTickets();  // Reload tickets to update status
            } else {
                alert("Please select someone to assign the ticket.");
            }
        };

        window.unassignTicket = async (docId) => {
            const ticketRef = doc(db, "tickets", docId);
            await updateDoc(ticketRef, {
                status: "New"
            });
            console.log("Ticket unassigned!");
            loadTickets();  // Reload tickets to reflect the change
        };

        window.deleteTicket = async (docId) => {
            if (confirm("Are you sure you want to delete this ticket?")) {
                await deleteDoc(doc(db, "tickets", docId));
                console.log("Ticket deleted!");
                loadTickets();  // Reload tickets to reflect the change
            }
        };

        
window.onload = async () => {
    await loadTickets(); // Load tickets when the page loads
    await loadMembers(); // Load members from Firestore
};



		// Ensure that onload setup is in place
window.onload = () => {
loadMembers();
    loadTickets(); // Initial load of tickets
    let members = Array.from(document.getElementById('memberSelect').options).map(option => option.value);
    updateSortFilter(members); // Setup sort filters with initial members
};


        //loadTickets();
        
        
    </script>
</body>
</html>